<!DOCTYPE html>

<html>

	<head>
		<meta charset="utf-8"/>
		<meta name="viewport" content="width=device-width,minimum-scale=1,maximum-scale=1,user-scalable=no,minimal-ui">
		<script type="text/javascript" src = "libs/RGA_core.js"></script>
		<style>
			html{
				touch-action: none;
				-ms-touch-action:none;
			}
	    	body {
		        margin: 0px;
		        background-color: black;
	        }
	        canvas {
				margin-left: auto;
				margin-right: auto;
				display: block;
			}
    	</style>
	</head>

	<body scroll="no" onload="start()" onresize="resize()">

		<canvas id="canvas" width="1280" height="720"> Your browser does not support canvas element :(  </canvas> 
		<script>

			/* canvas, context and related variables */
			var canvas  = document.getElementById("canvas");
			var context = canvas.getContext('2d');
			var width   = canvas.width, height = canvas.height;
			var rect    = canvas.getBoundingClientRect();
			var ratioW  = width  / canvas.width;
			var ratioH  = height / canvas.height;

			/* global variables */
			var debugMode = true;
			var isMobile = (/Android|webOS|iPhone|iPad|iPod|BlackBerry|BB|PlayBook|IEMobile|Windows Phone|Kindle|Silk|Opera Mini/i.test(navigator.userAgent));	
			var version = "RGA v0.3.2.2 debug mode"+ " - mobile: " + isMobile;
			var inMenu = true;

			/* global game variables */
			var rooms = ["menu", "game1"];
			var currentRoom = "game1";
			var request_id;

			var mouseClick = false;
		    var mouse_x, mouse_y;

			var requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame ||
                            			window.webkitRequestAnimationFrame || window.msRequestAnimationFrame;

			var cancelAnimationFrame = window.cancelAnimationFrame || window.mozCancelAnimationFrame;

		    /* events */
		    window.ontouchmove = function(event){ // disables gestures such as pinch and pan
		    	event.preventDefault();
		    	event.stopPropagation();
		    	return false;
			};

			window.oncontextmenu = function(event){ // disables the long-press event
		    	event.preventDefault();
		    	event.stopPropagation();
		    	return false;
			};

    		if(!isMobile){

    			var keyboardControl = false;
    			var pressedKey;

    			var keys   = new Array(false, false, false);
    			var keyNum = new Array(32, 37, 39);

				canvas.addEventListener('mousemove',
					function(event) {
						if(keyboardControl == false)
							updateMouse(event);
					});

				canvas.addEventListener('mousedown',
					function(event) {
						if(keyboardControl == false){
							updateMouse(event);
							mouseClick = true;
							//if(inMenu) requestFullScreen(document.body);
						}
					});

				canvas.addEventListener('mouseout', function() {mouseClick = false;});
				canvas.addEventListener('mouseup' , function() {mouseClick = false;});

				window.onkeydown = function(event){
					pressedKey = event.keyCode;
					switch(pressedKey){
						//case 32: keys[0] = true; break; // space
						case 37: keys[1] = true; break; // left arrow
						case 39: keys[2] = true; break; // right arrow
					}
					keyboardControl = true;	
				}

				window.onkeyup = function(event){			
					switch(event.keyCode){
						//case 32: keys[0] = false; break; // space
						case 37: keys[1] = false; break; // left arrow
						case 39: keys[2] = false; break; // right arrow
					}
					if(keys.every(isFalse)){
						keyboardControl = false;
						mouseClick = false;
						pressedKey = undefined;
					}else{
						for(var i=0; i<3; ++i){
							if(!isFalse(keys[i])) pressedKey = keyNum[i]; // choose another key that was also pressed
						}
					}
				};
			}else{

				var id, touchess;

				canvas.addEventListener('touchstart',
					function(event) {
					    mouseClick = true;
					    var newTouch = event.changedTouches[0];
					    touchess = event.touches;
					    id = newTouch.identifier;
					    updateMouse(newTouch);
				    });

				canvas.addEventListener('touchmove',
					function(event) {
						var lastMovedTouch = event.changedTouches[0];
				    	if(id == lastMovedTouch.identifier)
				    		updateMouse(lastMovedTouch);	  	
				    });

				canvas.addEventListener('touchend', 
					function(event) { 
						if(inMenu) requestFullScreen(document.body);
						var endedTouch = event.changedTouches[0];
						var leftTouches = event.touches;
						touchess = event.touches;
						var numTouches = leftTouches.length;
						if(numTouches == 0){
							mouseClick = false;
							id = undefined;
						}else if(id == endedTouch.identifier){
							id = leftTouches[numTouches-1].identifier;
							updateMouse(leftTouches[numTouches-1]);
						}
					});
			}

			function requestFullScreen(element) {
			    var requestMethod = 
			    element.requestFullScreen 	 || element.webkitRequestFullScreen ||
			    element.mozRequestFullScreen || element.msRequestFullScreen;
			    if (requestMethod) { // Native fullscreen
			        requestMethod.call(element);
			    } else if (typeof window.ActiveXObject !== "undefined") { // Older IE
			        var wscript = new ActiveXObject("WScript.Shell");
			        if (wscript !== null) {
			            wscript.SendKeys("{F11}");
			        }
			    }
			}

			function updateMouse(event){
				mouse_x = (event.clientX - rect.left) / ratioW;
			    mouse_y = (event.clientY - rect.top)  / ratioH;
			}

			function isFalse(bool){
				return (bool == false || !bool);
			}

			function resize(){
			
				if(window.innerWidth / window.innerHeight < canvas.width / canvas.height){
					width  = window.innerWidth;				
					height = width  * (canvas.height / canvas.width);
				}else{		
					height = window.innerHeight;
					width  = height * (canvas.width / canvas.height);
				}

				canvas.style.width  = width  + "px";
				canvas.style.height = height + "px";

				ratioW = width   / canvas.width;
				ratioH = height  / canvas.height;

				rect = canvas.getBoundingClientRect();
			}

			/* visual assets*/
			var img_empty 	   = loadImage("assets/empty.png")
			var img_ship 	   = loadImage("assets/gemi.png");
			var img_landscape  = loadImage("assets/landscape.png");
			var img_btn_left   = loadImage("assets/button_left.png");
			var img_btn_right  = loadImage("assets/button_right.png");
			var img_btn_left2  = loadImage("assets/button_left2.png");
			var img_btn_right2 = loadImage("assets/button_right2.png");

			var objects = [];

			/* GAME LOGIC BEGINS HERE */

			function start() {
				document.documentElement.style.overflow = "hidden"; // disable scrollbar
    			document.body.scroll = "no"; // disable scrollbar for ie browsers
				resize();
				load_welcome();
			}

			function load_welcome(){
				objects = [];
				objects.push(new Sprite(img_landscape, 360, 300, "center", "center", 1));
				objects.push(
					new GameButton(
						[new Sprite(img_empty, 1, 1, 0, 0), new Sprite(img_empty, 1, 1, 0, 0)],
						 new Rectangle(0, 0, canvas.width, canvas.height)));
				loop_welcome();
			}
								
			function loop_welcome() {

				request_id = requestAnimationFrame(loop_welcome);

				context.fillStyle = "#4E5E7A";
				context.fillRect(0, 0, canvas.width, canvas.height);

				objects[0].drawSprite(context, canvas.width/2, canvas.height/2);
				objects[1].updateSprite(context);

				if(window.innerHeight < window.innerWidth){
					if(objects[1].isClicked(mouseClick, mouse_x, mouse_y)){
						cancelAnimationFrame(request_id);
						load_game1(); 
						inMenu = false;
					}
				}
			}

			function load_game1(){

				objects = [];

				/* turn left and turn right buttons */
				objects.push(new GameButton(
					[new Sprite(img_btn_left, 160, 160, 0, 0), new Sprite(img_btn_left2, 160, 160, 0, 0)], 
					 new Rectangle(80, 500, 160, 160))
				);

				objects.push(new GameButton(
					[new Sprite(img_btn_right , 160, 160, 0, 0), new Sprite(img_btn_right2, 160, 160, 0, 0)],
					 new Rectangle(canvas.width - 240, 500, 160, 160))
				);

				/* the playable object */
				objects.push(
					new GameObject(new Sprite(img_ship, 81, 63, "center", "center", 1, 0), canvas.width / 2, canvas.height / 2, 90, 25, 4)
				);

				loop_game1(objects);

			}

			function loop_game1(){

				request_id = requestAnimationFrame(loop_game1);

				context.fillStyle = "#4E5E7A";
				context.fillRect(0, 0, canvas.width, canvas.height);

				var i = objects.length;

				objects[2].updateAngle();

				while (--i >= 0) {
					objects[i].updateSprite(context);
				}			

				/* draw the transparent green circle at the mouse position */
				/*if(mouseClick){
					drawCircle(context, 0.5, mouse_x, mouse_y, 60, "lime", "green", 10);
				}*/

				if(objects[0].isClicked(mouseClick, mouse_x, mouse_y)){
					objects[2].angle += 5;
				} // left button is clicked

				if(objects[1].isClicked(mouseClick, mouse_x, mouse_y)){
					objects[2].angle -= 5;

					if(objects[2].angle <=0)
						objects[2].angle += 360;
				} // right button is clicked

				if(keyboardControl == true){
					if(pressedKey == 37){
						mouse_x = objects[0].rectangle.x+80;
						mouse_y = objects[0].rectangle.y+80;
						mouseClick = true;
					}else if(pressedKey == 39){				
						mouse_x = objects[1].rectangle.x+80;
						mouse_y = objects[1].rectangle.y+80;
						mouseClick = true;
					}/*else if(pressedKey == 32){
						mouse_x = canvas.width / 2;
						mouse_y = objects[1].y+80; 
						mouseClick = true;
					}*/
				} // keyboard control

				/* checks vertical borders */
				if( objects[2].x - objects[2].radius <= 0 || objects[2].x + objects[2].radius  >= canvas.width){
					objects[2].x = objects[2].prev_x;
					objects[2].y = objects[2].prev_y;
					objects[2].angle += 2 * getVerticalAngle(objects[2].angle);
				}
					
				/* checks horizontal borders */	
				if( objects[2].y - objects[2].radius  <= 0 || objects[2].y + objects[2].radius >= canvas.height){
					objects[2].x = objects[2].prev_x;
					objects[2].y = objects[2].prev_y;
					objects[2].angle += 2 * getHorizontalAngle(objects[2].angle);
				}

				if(debugMode){

					context.fillStyle = "white";
					context.font = "18px Verdana";
					context.fillText(version, 20, 30);
					context.fillText(mouseClick + " at x: " + Math.round(mouse_x) + " y: " + Math.round(mouse_y), 20, 60); 

					var isFullscreen = (screen.availHeight || screen.height-30) <= window.innerHeight;

					context.fillText("fullscreen: " + isFullscreen, 20, 120);			

					//drawCircle(context, 0.5, objects[2].x, objects[2].y, objects[2].radius, "blue", "black", 2);
					
					if(isMobile){
						context.fillText("following: " + id, canvas.width-200, 30);
						if(touchess != undefined){
							for(i=0;i<touchess.length;i++){
								context.fillText(touchess[i].identifier, canvas.width-300, 30 + i*30);
							}
						}
					}else{
						context.fillText(keys, 20, 90); 
					}

				} // debug mode end

			} // loop_game1 end

		</script>

	</body>

</html> 
